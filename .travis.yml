sudo: required
dist: xenial

language: rust
rust:
  - nightly
  - stable
os:
  - linux
cache:
  cargo: true
  apt: true

branches:
  only:
    - master
addons:
  apt:
    packages:
      - zlib1g-dev
      - libssl-dev
      - pkg-config
      - cmake
      - zfsutils-linux
env:
  global:
    - RUSTFLAGS="-C link-dead-code"
before_cache: |
  if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
    RUSTFLAGS="--cfg procmacro2_semver_exempt" cargo install cargo-tarpaulin -f
  fi

before_script:
  - cd $TRAVIS_BUILD_DIR
  - sudo mkdir /vdevs && sudo chmod 777 /vdevs
script:
  - sudo $(which cargo) test
  - sudo chmod -R 777 /home/travis/.cargo/registry/
  - sudo chmod -R 777 /home/travis/build/Inner-Heaven/libzfs-rs/target/

after_success: |
  if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
    sudo $(which cargo) tarpaulin --out Xml
    bash <(curl -s https://codecov.io/bash)
  fi
