sudo: required
dist: trusty

language: rust
rust:
  - nightly
  - beta
  - stable
os:
  - linux
cache:
  cargo: true
  apt: true

branches:
  only:
    - master
addons:
  apt:
    packages:
      - libblkid-dev
      - libattr1-dev
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - cmake
      - gcc
      - binutils-dev
      - libiberty-dev
      - zlib1g-dev
      - libssl-dev
env:
  global:
    - RUSTFLAGS="-C link-dead-code"
    - rel=0.7.12
before_cache: |
  if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
    RUSTFLAGS="--cfg procmacro2_semver_exempt" cargo install cargo-tarpaulin -f
  fi

before_script:
  - ls /etc/apt/sources.list.d/
  - MAKEFLAGS=-j$(($(grep -c '^processor' /proc/cpuinfo) * 2 + 1))
  - sudo apt-get install -qq -y linux-headers-$(uname -r) uuid-dev tree
  - cd /tmp
  - curl -L https://github.com/zfsonlinux/zfs/releases/download/zfs-$rel/spl-$rel.tar.gz | tar xz
  - curl -L https://github.com/zfsonlinux/zfs/releases/download/zfs-$rel/zfs-$rel.tar.gz | tar xz
  - (cd spl-$rel && ./configure --prefix=/usr && make && sudo make install) > /dev/null
  - (cd zfs-$rel && ./configure --prefix=/usr && make && sudo make install) > /dev/null
  - sudo modprobe zfs
  - cd $TRAVIS_BUILD_DIR
  - sudo mkdir /vdevs && sudo chmod 777 /vdevs
  - rustup component add clippy --toolchain=nightly || cargo install --git https://github.com/rust-lang/rust-clippy/ --force clippy
script:
  - cargo build
  - sudo $(which cargo) test

after_success: |
  if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
    sudo $(which cargo) tarpaulin --out Xml
    bash <(curl -s https://codecov.io/bash)

    cargo clippy
  fi
